(()=>{"use strict";var e={d:(t,i)=>{for(var a in i)e.o(i,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:i[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{arraySwap:()=>c,getCurrentTime:()=>a,isFunction:()=>n,isTouchDevice:()=>o,random:()=>s,randomPositiveNegative:()=>r,requestAnimationFrameTool:()=>h});var i={};e.r(i),e.d(i,{backgroundName:()=>E,beforeDrop:()=>U,bgImgOffset:()=>V,bgInitMovement:()=>Y,bgLinearGradientOffset:()=>M,blockCount:()=>P,blockHeight:()=>_,blockName:()=>L,blockWidth:()=>F,cloudSize:()=>S,drop:()=>j,failedCount:()=>f,flightCount:()=>C,flightLayer:()=>W,gameScore:()=>k,gameStartNow:()=>p,gameUserOption:()=>y,hardMode:()=>w,hookDown:()=>T,hookDownMovement:()=>q,hookNormal:()=>A,hookUp:()=>I,hookUpMovement:()=>z,initialAngle:()=>B,land:()=>X,lightningMovement:()=>Q,lineInitialOffset:()=>O,moveDownMovement:()=>J,out:()=>K,perfectCount:()=>v,raindropSize:()=>R,raindropSpeed:()=>N,ropeHeight:()=>D,rotateLeft:()=>G,rotateRight:()=>H,successCount:()=>x,swing:()=>$,tutorialMovement:()=>Z});const a=()=>performance.now(),s=(e,t)=>Math.random()*(t-e)+e,r=()=>Math.random()<.5?-1:1,n=e=>"function"==typeof e,o=()=>"ontouchstart"in window||window.navigator.msMaxTouchPoints,h=(()=>{let e=1e3/60;return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(t=>{window.setTimeout((()=>{const i=a();t(i);const s=a();e=1e3/60-(s-i)}),e)})})(),c=(e,t,i)=>{const a=e[i];e[i]=e[t],e[t]=a},d={linear:function(e,t,i,a){return i*e/a+t},easeIn:function(e,t,i,a){return i*(e/=a)*e+t},easeOut:function(e,t,i,a){return-i*(e/=a)*(e-2)+t},easeInOut:function(e,t,i,a){return(e/=a/2)<1?i/2*e*e+t:-i/2*(--e*(e-2)-1)+t}},{requestAnimationFrameTool:l,isFunction:g,isTouchDevice:u}=t;class m{constructor(e={}){if(!document.createElement("canvas").getContext)return void window.alert("HTML5 Canvas is not supported in your browser.");const{canvasId:i,debug:a,width:s,height:r,highResolution:n,loadLimit:o,soundOn:h}=e;let c=s||window.innerWidth,d=r||window.innerHeight;this.canvas=document.getElementById(i),n&&(this.canvas.style.width=`${c}px`,this.canvas.style.height=`${d}px`,c*=2,d*=2),this.highResolution=n,this.canvas.width=c,this.canvas.height=d,this.width=this.canvas.width,this.height=this.canvas.height,this.calWidth=.5*this.width,this.calHeight=.5*this.height,this.debug=!!a,this.ctx=this.canvas.getContext("2d"),this.defaultLayer="default",this.layerArr=[this.defaultLayer],this.instancesObj={},this.instancesObj[this.defaultLayer]=[],this.instancesReactionArr=[],this.utils=t,this.customVariable={};const l=this;this.isTouchDevice=u(),this.debugArr=[],this.assetsObj={image:{},audio:{}},this.assetsCount={image:0,audio:0},this.assetsErrorQueue=[],this.assetsErrorCount=0,this.loadLimit=o||3,this.soundOn=!!h,this.fps=0,this.lastTime=0,this.lastPausedAt=0,this.pausedTime=0,this.paused=!1,this.timeMovement={},this.timeMovementStartArr=[],this.timeMovementFinishArr=[],this.keyUpListeners={},this.keyDownListeners={},this.keyPressListeners={},this.startAnimate=()=>{},this.paintUnderInstance=()=>{},this.paintAboveInstance=()=>{},this.endAnimate=()=>{},this.touchStartListener=()=>{},this.touchEndListener=()=>{},this.touchMoveListener=()=>{},document.addEventListener("keyup",(e=>{l.keyListener(e,"keyup")}),!1),document.addEventListener("keydown",(e=>{l.keyListener(e,"keydown")}),!1),document.addEventListener("keypress",(e=>{l.keyListener(e,"keypress")}),!1),this.isTouchDevice?(document.addEventListener("touchstart",(e=>{l.touchStartListener(e)}),!1),document.addEventListener("touchend",(e=>{l.touchEndListener(e)}),!1),document.addEventListener("touchmove",(e=>{l.touchMoveListener(e)}),!1)):(document.addEventListener("mousedown",(e=>{l.touchStartListener(e)}),!1),document.addEventListener("mouseup",(e=>{l.touchEndListener(e)}),!1),document.addEventListener("mousemove",(e=>{l.touchMoveListener(e)}),!1))}triggerReaction(e,t){let i=e,a=t;this.highResolution&&(i*=2,a*=2),this.instancesReactionArr.forEach((e=>{e.visible&&i>=e.x&&i<=e.x+e.width&&a>=e.y&&a<=e.y+e.height&&e.trigger(e,this)}))}addAudio(e,t,i=0){if(!this.soundOn)return;i||(this.assetsCount.audio+=1);const a=new window.Audio;a.src=t,this.assetsObj.audio[e]=a,a.addEventListener("error",(()=>{this.assetsErrorQueue.push({name:e,src:t,retry:i+1,type:"audio"})}),!1),a.load()}getAudio(e){return this.assetsObj.audio[e]}playAudio(e,t=!1){if(!this.soundOn)return;const i=this.getAudio(e);if(i){if(i.play(),!t)return;i.addEventListener("ended",(()=>{i.currentTime=0,i.play()}),!1)}}pauseAudio(e){const t=this.getAudio(e);t&&t.pause()}setVariable(e,t){this.customVariable[e]=t}getVariable(e,t=null){return this.customVariable[e]||(null!==t?(this.setVariable(e,t),t):null)}addImg(e,t,i=0){i||(this.assetsCount.image+=1);const a=new window.Image;a.src=t,a.onload=()=>{this.assetsObj.image[e]=a},a.onerror=()=>{this.assetsErrorQueue.push({name:e,src:t,retry:i+1,type:"image"})}}getImg(e){return this.assetsObj.image[e]}animate(e){const t=e-this.pausedTime,i=this;this.paused?setTimeout((()=>{this.animate.call(i,t)}),100):(this.tick(t),this.clean(),this.startAnimate(this,t),this.paintUnderInstance(this),this.updateInstances(t),this.paintInstances(),this.paintAboveInstance(),this.endAnimate(this,t),this.tickTimeMovement(),this.debug&&this.showFps(),this.debug&&this.drawDebug(),l((e=>{this.animate.call(i,e)})))}showFps(){this.ctx.save(),this.ctx.fillStyle="red",this.ctx.font=(this.highResolution?32:16)+"px Arial",this.ctx.fillText(`FPS: ${this.fps.toFixed()}`,5,this.highResolution?40:20),this.ctx.restore()}debugLineX(e){this.debugArr.push({type:"lineX",y:e})}debugLineY(e){this.debugArr.push({type:"lineY",x:e})}debugDot(e,t){this.debugArr.push({type:"dot",x:e,y:t})}drawDebug(){this.debugArr.forEach((e=>{const{type:t,x:i,y:a}=e;switch(t){case"dot":this.drawDebugDot(i,a);break;case"lineX":this.drawDebugLine(null,a);break;case"lineY":this.drawDebugLine(i,null)}})),this.instancesReactionArr.forEach((e=>{e.visible&&(this.ctx.strokeStyle="red",this.ctx.beginPath(),this.ctx.rect(e.x,e.y,e.width,e.height),this.ctx.stroke())}))}drawDebugLine(e,t){let i=[0,t],a=[this.width,t];e&&(i=[e,0],a=[e,this.height]),this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.beginPath(),this.ctx.moveTo(...i),this.ctx.lineTo(...a),this.ctx.stroke(),this.ctx.restore()}drawDebugDot(e,t){this.ctx.save(),this.ctx.fillStyle="red",this.ctx.beginPath(),this.ctx.arc(e,t,2,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.fillStyle="white",this.ctx.beginPath(),this.ctx.arc(e,t,1,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.restore()}tick(e){this.updateFps(e),this.lastTime=e}updateFps(e){0===this.lastTime?this.fps=60:this.fps=1e3/(e-this.lastTime)}pixelsPerFrame(e){return e/this.fps}tickTimeMovement(){this.timeMovementStartArr.forEach((e=>{this.timeMovement[e].processing=!0})),this.timeMovementStartArr=[],this.timeMovementFinishArr.forEach((e=>{delete this.timeMovement[e]})),this.timeMovementFinishArr=[]}getTimeMovement(e,t,i,a={}){const{before:s,after:r}=a,n=d[a.easing||"linear"],o=a.name||"default",h=this.timeMovement[e];if(!h)return;h.processing||(this.timeMovementStartArr.push(e),h.store[o]=[],t.forEach((e=>{h.store[o].push({start:parseFloat(e[0]),end:parseFloat(e[1])})})),s&&s());const c=(e=!1)=>{const{duration:t}=h;let a=t;if(!e){const e=this.utils.getCurrentTime(),{startTime:t}=h;a=e-t}const s=h.store[o].map((e=>n(a,e.start,e.end-e.start,t)));i.apply(this,s)};this.checkTimeMovement(e)?c():(this.timeMovementFinishArr.push(e),c(!0),r&&r())}checkTimeMovement(e){const t=this.timeMovement[e]||{};return this.utils.getCurrentTime()<=t.endTime}setTimeMovement(e,t){const i=this.utils.getCurrentTime();this.timeMovement[e]={startTime:i,endTime:i+t,duration:t,store:{}}}clean(){this.ctx.clearRect(0,0,this.width,this.height),this.debugArr=[]}addLayer(e){this.layerArr.push(e),this.instancesObj[e]=[]}removeLayer(e){this.layerArr=this.layerArr.filter((t=>t!==e)),delete this.instancesObj[e]}swapLayer(e,t){this.utils.arraySwap(this.layerArr,e,t)}addInstance(e,t=this.defaultLayer){this.instancesObj[t].push(e),e.trigger&&this.instancesReactionArr.push(e)}getInstance(e,t=this.defaultLayer){return this.instancesObj[t].filter((t=>t.name===e))[0]}removeInstance(e,t=this.defaultLayer){const i=this.getInstance(e,t);i&&(this.instancesObj[t]=this.instancesObj[t].filter((t=>t.name!==e)),i.trigger&&(this.instancesReactionArr=this.instancesReactionArr.filter((t=>t.name!==e))))}updateInstances(e){this.layerArr.forEach((t=>{this.instancesObj[t].forEach((t=>{t.update&&t.update(this,e)}))}))}paintInstances(){this.layerArr.forEach((e=>{this.instancesObj[e].forEach((e=>{e.paint&&e.paint(this)}))}))}togglePaused(){const e=this.utils.getCurrentTime();this.paused=!this.paused,this.paused?this.lastPausedAt=e:this.pausedTime+=e-this.lastPausedAt}addKeyUpListener(e,t){this.keyUpListeners[e]=t}addKeyDownListener(e,t){this.keyDownListeners[e]=t}addKeyPressListener(e,t){this.keyPressListeners[e]=t}findKeyListener(e,t){return"keyup"===t?this.keyUpListeners[e]:"keydown"===t?this.keyDownListeners[e]:this.keyPressListeners[e]}keyListener(e,t){let i;switch(e.keyCode){case 13:i="enter";break;case 32:i="space";break;case 37:i="leftArrow";break;case 39:i="rightArrow";break;case 38:i="upArrow";break;case 40:i="downArrow";break;default:i=e.keyCode}const a=this.findKeyListener(i,t);a&&a()}load(e,t){const i=setInterval((()=>{const a=this.assetsCount.image+this.assetsCount.audio,s=Object.keys(this.assetsObj.image).length+Object.keys(this.assetsObj.audio).length;t&&g(t)&&t({success:s,failed:this.assetsErrorCount,total:a}),this.assetsErrorQueue.length>0&&(this.assetsErrorQueue.forEach((e=>{const{retry:t,name:i,src:a,type:s}=e;t>=this.loadLimit?this.assetsErrorCount+=1:"image"===s?this.addImg(i,a,t):this.addAudio(i,a,t)})),this.assetsErrorQueue=[]),s===a&&(e&&g(e)?e():this.init(),clearInterval(i))}),200)}init(){const e=this;l((t=>{this.animate.call(e,t)}))}}class b{constructor(e={}){const{name:t,painter:i,action:a,trigger:s}=e;this.name=t,this.x=0,this.y=0,this.width=0,this.height=0,this.ax=0,this.ay=0,this.vx=0,this.vy=0,this.visible=!0,this.painter=i||null,this.action=a||null,this.trigger=s||null,this.ready=!1}paint(e){null!==this.painter&&this.visible&&this.painter(this,e)}update(e,t){null!==this.action&&this.action(this,e,t)}updateWidth(e){this.width=e,this.calWidth=e/2}updateHeight(e){this.height=e,this.calHeight=e/2}}const p="GAME_START_NOW",y="GAME_USER_OPTION",w="HARD_MODE",x="SUCCESS_COUNT",f="FAILED_COUNT",v="PERFECT_COUNT",k="GAME_SCORE",T="HOOK_DOWN",I="HOOK_UP",A="HOOK_NORMAL",V="BACKGROUND_IMG_OFFSET_HEIGHT",O="LINE_INITIAL_OFFSET",M="BACKGROUND_LINEAR_GRADIENT_OFFSET_HEIGHT",L="block",E="background",P="BLOCK_COUNT",F="BLOCK_WIDTH",_="BLOCK_HEIGHT",S="CLOUD_SIZE",R="RAINDROP_SIZE",N="RAINDROP_SPEED",D="ROPE_HEIGHT",C="FLIGHT_COUNT",W="FLIGHT_LAYER",H="ROTATE_RIGHT",G="ROTATE_LEFT",$="SWING",U="BEFORE_DROP",j="DROP",X="LAND",K="OUT",B="INITIAL_ANGLE",Y="BG_INIT_MOVEMENT",q="HOOK_DOWN_MOVEMENT",z="HOOK_UP_MOVEMENT",Q="LIGHTNING_MOVEMENT",Z="TUTORIAL_MOVEMENT",J="MOVE_DOWN_MOVEMENT",ee=e=>e.checkTimeMovement(J),te=(e,t)=>{const i=t?t.pixelsPerFrame:e.pixelsPerFrame.bind(e),a=e.getVariable(x),s=2*e.getVariable(_);return i(a<=4?1.25*s:s)},ie=(e,t)=>{const i=e.getVariable(x),a=e.getVariable(k),{hookSpeed:s}=e.getVariable(y);if(s)return s(i,a);let r;switch(!0){case i<1:r=0;break;case i<10:r=1;break;case i<20:r=.8;break;case i<30:r=.7;break;default:r=.74}return e.getVariable(w)&&(r=1.1),Math.sin(t/(200/r))},ae=(e,t)=>{const i=e.getVariable(x),a=e.getVariable(k),{landBlockSpeed:s}=e.getVariable(y);if(s)return s(i,a);const{width:r}=e;let n;switch(!0){case i<5:n=0;break;case i<13:n=.001;break;case i<23:n=.002;break;default:n=.003}return Math.cos(t/200)*n*r},se=e=>e.checkTimeMovement(q)?T:e.checkTimeMovement(z)?I:A,re=e=>{const{setGameFailed:t}=e.getVariable(y),i=e.getVariable(f)+1;e.setVariable(f,i),e.setVariable(v,0),t&&t(i),i>=3&&(e.pauseAudio("bgm"),e.playAudio("game-over"),e.setVariable(p,!1))},ne=(e,t)=>{const{setGameScore:i,successScore:a,perfectScore:s}=e.getVariable(y),r=e.getVariable(v,0),n=t?r+1:0,o=e.getVariable(k)+(a||25)+(s||25)*n;e.setVariable(k,o),e.setVariable(v,n),i&&i(o)},oe=(e,t)=>{const{string:i,size:a,x:s,y:r,textAlign:n,fontName:o="wenxue",fontWeight:h="normal"}=t,{ctx:c}=e,d=a,l=.1*d;c.save(),c.beginPath();const g=c.createLinearGradient(0,0,0,r);g.addColorStop(0,"#FAD961"),g.addColorStop(1,"#F76B1C"),c.fillStyle=g,c.lineWidth=l,c.strokeStyle="#FFF",c.textAlign=n||"center",c.font=`${h} ${d}px ${o}`,c.strokeText(i,s,r),c.fillText(i,s,r),c.restore()},he=(e,t,i)=>{const a=t+1>=e.length?e.length-1:t,s=e[a],r=e[a+1>=e.length-1?a:a+1],n=e=>{const t=s[e],a=r[e];return Math.round(t+(a-t)*i)};return`rgb(${n(0)}, ${n(1)}, ${n(2)})`},ce=e=>{(e=>{const t=e.ctx.createLinearGradient(0,0,0,e.height);let i=[];switch(e.getVariable(E)){case"background":i=[[200,255,150],[105,230,240],[90,190,240],[85,100,190],[55,20,35],[75,25,35],[25,0,10]];break;case"greenbackground":i=[[255,255,150],[240,230,120],[220,200,90],[200,170,60],[180,140,40],[100,50,20],[20,0,10]];break;default:i=[[184,218,217],[140,179,184],[115,150,145],[90,120,105],[70,90,75],[55,60,50],[25,0,10]]}const a=e.getVariable(M,0);ee(e)&&e.setVariable(M,a+1.5*te(e));const s=parseInt(a/e.height,10),r=a%e.height/e.height,n=he(i,s,r),o=he(i,s+1,r);t.addColorStop(0,o),t.addColorStop(1,n),e.ctx.fillStyle=t,e.ctx.beginPath(),e.ctx.rect(0,0,e.width,e.height),e.ctx.fill();const h=()=>{e.ctx.fillStyle="rgba(255, 255, 255, 0.7)",e.ctx.fillRect(0,0,e.width,e.height)};e.getTimeMovement(Q,[],(()=>{}),{before:h,after:h})})(e),(e=>{const t=e.getImg(e.getVariable(E)),i=t.width,a=t.height*e.width/i;let s=e.getVariable(V,e.height-a);s>e.height||(e.getTimeMovement(J,[[s,s+te(e,{pixelsPerFrame:e=>e/2})]],(e=>{s=e}),{name:"background"}),e.getTimeMovement(Y,[[s,s+a/4]],(e=>{s=e})),e.setVariable(V,s),e.setVariable(O,e.height-.394*a),e.ctx.drawImage(t,0,s,e.width,a))})(e)},de=(e,t,i)=>{const a=e;a.ready||(a.y=t.getVariable(O),a.ready=!0,a.collisionX=t.width-t.getVariable(F)),t.getTimeMovement(J,[[e.y,e.y+te(t,{pixelsPerFrame:e=>e/2})]],(t=>{e.y=t}),{name:"line"});const s=ae(t,i);e.x+=s,e.collisionX+=s},le=(e,t)=>{const{ctx:i,debug:a}=t;a&&(i.save(),i.beginPath(),i.strokeStyle="red",i.moveTo(e.x,e.y),i.lineTo(e.collisionX,e.y),i.lineWidth=1,i.stroke(),i.restore())},ge=e=>{const{count:t}=e;var i;e.imgName=(i=t>6?["c4","c5","c6","c7","c8"]:["c1","c2","c3"])[Math.floor(Math.random()*i.length)]},ue=(e,t)=>{if(!e.ready){e.ready=!0,ge(e),e.width=t.getVariable(S),e.height=t.getVariable(S);const i=t.width,a=t.height,s=[{x:.1*i,y:.66*-a},{x:.65*i,y:.33*-a},{x:.1*i,y:0},{x:.65*i,y:.33*a}][e.index-1];e.x=t.utils.random(s.x,1.2*s.x),e.originX=e.x,e.ax=t.pixelsPerFrame(e.width*t.utils.random(.05,.08)*t.utils.randomPositiveNegative()),e.y=t.utils.random(s.y,1.2*s.y)}e.x+=e.ax,(e.x>=e.originX+e.width||e.x<=e.originX-e.width)&&(e.ax*=-1),ee(t)&&(e.y+=1.2*te(t)),e.y>=t.height&&(e.y=.66*-t.height,e.count+=4,ge(e))},me=(e,t)=>{const{ctx:i}=t,a=t.getImg(e.imgName);i.drawImage(a,e.x,e.y,e.width,e.height)},be=(e,t,i)=>{const a=t.getVariable(D);e.ready||(e.x=t.width/2,e.y=-1.5*a,e.ready=!0),t.getTimeMovement(z,[[e.y,e.y-a]],(t=>{e.y=t}),{after:()=>{e.y=-1.5*a}}),t.getTimeMovement(q,[[e.y,e.y+a]],(t=>{e.y=t}),{name:"hook"});const s=t.getVariable(B);e.angle=s*ie(t,i),e.weightX=e.x+Math.sin(e.angle)*a,e.weightY=e.y+Math.cos(e.angle)*a},pe=(e,t)=>{const{ctx:i}=t,a=t.getVariable(D),s=.1*a,r=t.getImg("hook");i.save(),i.translate(e.x,e.y),i.rotate(2*Math.PI-e.angle),i.translate(-e.x,-e.y),t.ctx.drawImage(r,e.x-s/2,e.y,s,a+5),i.restore()},ye=(e,t,i)=>{const{width:a,height:s}=t,{name:r}=e;if(!e.ready){e.ready=!0;const i=.2*a;e.updateWidth(i),e.height=.46*i,e.x=t.calWidth-e.calWidth,e.y=.45*s,"tutorial"!==r&&(e.y+=1.2*e.height)}"tutorial"!==r&&(e.y+=Math.cos(i/200)*e.height*.01)},we=(e,t)=>{if(t.checkTimeMovement(Z))return;if(se(t)!==A)return;const{ctx:i}=t,{name:a}=e,s=t.getImg(a);i.drawImage(s,e.x,e.y,e.width,e.height)},xe=(e,t)=>{e.status===G?e.y-e.width>=t.height&&(e.visible=!1,e.status=K,re(t)):e.y>=t.height&&(e.visible=!1,e.status=K,re(t))},fe=(e,t,i)=>{const a=e,s=t.getVariable(D);if(!a.visible)return;a.ready||(a.ready=!0,a.status=$,e.updateWidth(t.getVariable(F)),e.updateHeight(t.getVariable(_)),e.x=t.width/2,e.y=-1.5*s);const r=t.getInstance("line");switch(a.status){case $:t.getTimeMovement(q,[[e.y,e.y+s]],(t=>{e.y=t}),{name:"block"}),((e,t,i)=>{const a=t.getVariable(D);if(e.status!==$)return;const s=e,r=t.getVariable(B);s.angle=r*ie(t,i),s.weightX=s.x+Math.sin(s.angle)*a,s.weightY=s.y+Math.cos(s.angle)*a})(e,t,i);break;case U:a.x=e.weightX-e.calWidth,a.y=e.weightY+.3*e.height,a.rotate=0,a.ay=t.pixelsPerFrame(3e-4*t.height),a.startDropTime=i,a.status=j;break;case j:const n=i-a.startDropTime;a.startDropTime=i,a.vy+=a.ay*n,a.y+=a.vy*n+.5*a.ay*n**2;const o=((e,t)=>e.y+e.height>=t.y?e.x<t.x-e.calWidth||e.x>t.collisionX+e.calWidth?1:e.x<t.x?2:e.x>t.collisionX?3:e.x>t.x+.8*e.calWidth&&e.x<t.x+1.2*e.calWidth?5:4:0)(e,r),h=r.y-e.height,c=e=>{e.originOutwardAngle=Math.atan(e.height/e.outwardOffset),e.originHypotenuse=Math.sqrt(e.height**2+e.outwardOffset**2),t.playAudio("rotate")};switch(o){case 1:xe(e,t);break;case 2:a.status=G,e.y=h,e.outwardOffset=r.x+e.calWidth-e.x,c(e);break;case 3:a.status=H,e.y=h,e.outwardOffset=r.collisionX+e.calWidth-e.x,c(e);break;case 4:case 5:a.status=X;const i=t.getVariable(x);(e=>{const{setGameSuccess:t}=e.getVariable(y),i=e.getVariable(x)+1;e.setVariable(x,i),e.getVariable(w)&&e.setVariable(D,e.height*e.utils.random(.35,.55)),t&&t(i)})(t),t.setTimeMovement(J,500),10!==i&&15!==i||t.setTimeMovement(Q,150),e.y=h,r.y=h,r.x=a.x-a.calWidth,r.collisionX=r.x+a.width;const s=.3*a.width;(a.x>t.width-2*s||a.x<-s)&&t.setVariable(w,!0),5===o?(e.perfect=!0,ne(t,!0),t.playAudio("drop-perfect")):(ne(t),t.playAudio("drop"))}break;case X:t.getTimeMovement(J,[[e.y,e.y+te(t,{pixelsPerFrame:e=>e/2})]],(i=>{e.visible&&(e.y=i,e.y>t.height&&(e.visible=!1))}),{name:e.name}),e.x+=ae(t,i);break;case G:case H:const d=a.status===H,l=t.pixelsPerFrame(4*Math.PI),g=d?1:-1;if(d?e.rotate>1.3:e.rotate<-1.3)e.rotate+=l/8*g,e.y+=t.pixelsPerFrame(.7*t.height),e.x+=t.pixelsPerFrame(.3*t.width)*g;else{let t=(e.calWidth-e.outwardOffset)/e.calWidth;t=t>.5?t:.5,e.rotate+=l*t*g;const i=e.originOutwardAngle+e.rotate,a=d?r.collisionX+e.calWidth:r.x+e.calWidth,s=r.y;e.x=a-Math.cos(i)*e.originHypotenuse,e.y=s-Math.sin(i)*e.originHypotenuse}xe(e,t)}},ve=(e,t)=>{const{perfect:i}=e,a=t.getImg(i?"block-perfect":t.getVariable(L));t.ctx.drawImage(a,e.x,e.y,e.width,e.height)},ke=(e,t)=>{const{status:i}=e;switch(i){case $:((e,t)=>{const i=t.getImg(t.getVariable(L)+"Rope");t.ctx.drawImage(i,e.weightX-e.calWidth,e.weightY,e.width,1.3*e.height);const a=e.weightX-e.calWidth;t.debugLineY(a)})(e,t);break;case j:case X:ve(e,t);break;case G:case H:((e,t)=>{const{ctx:i}=t;i.save(),i.translate(e.x,e.y),i.rotate(e.rotate),i.translate(-e.x,-e.y),ve(e,t),i.restore()})(e,t)}},Te=(e,t)=>{const{visible:i,ready:a,type:s}=e;if(!i)return;const r=t.getVariable(S);if(!a){const i=((e,t)=>{const{width:i,height:a,utils:s}=e,{random:r}=s,n=e.getVariable(S);return{bottomToTop:{x:i*r(.3,.7),y:a,vx:0,vy:.7*e.pixelsPerFrame(a)*-1},leftToRight:{x:-1*n,y:a*r(.3,.6),vx:.4*e.pixelsPerFrame(i),vy:.1*e.pixelsPerFrame(a)*-1},rightToLeft:{x:i,y:a*r(.2,.5),vx:.4*e.pixelsPerFrame(i)*-1,vy:.1*e.pixelsPerFrame(a)},rightTopToLeft:{x:i,y:0,vx:.6*e.pixelsPerFrame(i)*-1,vy:.5*e.pixelsPerFrame(a)}}[t]})(t,s);e.ready=!0,e.width=r,e.height=r,e.x=i.x,e.y=i.y,e.vx=i.vx,e.vy=i.vy}e.x+=e.vx,e.y+=e.vy,(e.y+r<0||e.y>t.height||e.x+r<0||e.x>t.width)&&(e.visible=!1)},Ie=(e,t)=>{const{ctx:i}=t,a=t.getImg(e.imgName);i.drawImage(a,e.x,e.y,e.width,e.height)},Ae=(e,t,i)=>{if(e.getVariable(C)===t)return;const a=new b({name:`flight_${t}`,action:Te,painter:Ie});a.imgName=`f${t}`,a.type=i,e.addInstance(a,W),e.setVariable(C,t)},Ve=e=>{if(!e.getVariable(p))return;const t=e.getVariable(x,0),i=e.getVariable(f),a=e.getVariable(k,0),s=Number(t)>99?.1*e.width:0;oe(e,{string:"floor",size:.06*e.width,x:.24*e.width+s,y:.12*e.width,textAlign:"left",fontName:"Arial",fontWeight:"bold"}),oe(e,{string:t,size:.17*e.width,x:.22*e.width+s,y:.2*e.width,textAlign:"right"});const r=e.getImg("score"),n=r.width,o=r.height,h=.35*e.width,c=o*h/n;e.ctx.drawImage(r,.61*e.width,.038*e.width,h,c),oe(e,{string:a,size:.06*e.width,x:.9*e.width,y:.11*e.width,textAlign:"right"});const{ctx:d}=e,l=e.getImg("heart"),g=l.width,u=l.height,m=.08*e.width,b=u*m/g;for(let t=1;t<=3;t+=1)d.save(),t<=i&&(d.globalAlpha=.2),d.drawImage(l,.66*e.width+(t-1)*m,.16*e.width,m,b),d.restore()},Oe=e=>{if(!e.getVariable(p))return;const t=e.getInstance(`block_${e.getVariable(P)}`);if(!t||[X,K].indexOf(t.status)>-1){if(ee(e)&&te(e))return;if(e.checkTimeMovement(z))return;const t=(e=>{const t=e.getVariable(x),i=e.getVariable(k),{hookAngle:a}=e.getVariable(y);if(a)return a(t,i);if(e.getVariable(w))return 90;switch(!0){case t<10:return 30;case t<20:return 60;default:return 80}})(e),i=Math.PI*e.utils.random(t,t+5)*e.utils.randomPositiveNegative()/180;e.setVariable(P,e.getVariable(P)+1),e.setVariable(B,i),e.setTimeMovement(q,500);const a=new b({name:`block_${e.getVariable(P)}`,action:fe,painter:ke});e.addInstance(a)}switch(Number(e.getVariable(x,0))){case 2:Ae(e,1,"leftToRight");break;case 6:Ae(e,2,"rightToLeft");break;case 8:Ae(e,3,"leftToRight");break;case 14:Ae(e,4,"bottomToTop");break;case 18:Ae(e,5,"bottomToTop");break;case 22:Ae(e,6,"bottomToTop");break;case 25:Ae(e,7,"rightTopToLeft")}},Me=(e,t)=>{const{ctx:i}=t,a=t.getImg(e.imgName);i.drawImage(a,e.x,e.y,e.width,e.height)},Le=(e,t)=>{e.ready||(e.ready=!0,e.imgName="raindrop",e.width=t.getVariable(R),e.height=t.getVariable(R),e.x=t.utils.random(0,t.width-e.width),e.originX=e.x,e.y=t.utils.random(-t.height,-10)),e.y+=t.getVariable(N),ee(t)&&(e.y+=1.2*te(t)),e.y>=t.height&&(e.y=t.utils.random(2*-t.height,-10),e.x=t.utils.random(0,t.width-e.width),e.cloud.count>4&&t.removeInstance(e.name))};window.TowerGame=(e={})=>{const{width:t,height:a,canvasId:s,soundOn:r}=e,n=new m({canvasId:s,highResolution:!0,width:t,height:a,soundOn:r});n.setVariable(L,e.block),n.setVariable(E,e.block.split("block")[0]+"background");const o=e=>`./assets/${e}`;n.constant=i,n.addImg("background",o("background.png")),n.addImg("bluebackground",o("bluebackground.png")),n.addImg("greenbackground",o("greenbackground.png")),n.addImg("hook",o("hook.png")),n.addImg("blockRope",o("block-rope.png")),n.addImg("block",o("block.png")),n.addImg("blueblockRope",o("blueblock-rope.png")),n.addImg("blueblock",o("blueblock.png")),n.addImg("greenblockRope",o("greenblock-rope.png")),n.addImg("greenblock",o("greenblock.png")),n.addImg("block-perfect",o("block-perfect.png"));for(let e=1;e<=8;e+=1)n.addImg(`c${e}`,o(`c${e}.png`));n.addLayer(W);for(let e=1;e<=7;e+=1)n.addImg(`f${e}`,o(`f${e}.png`));n.swapLayer(0,1),n.addImg("tutorial",o("tutorial.png")),n.addImg("tutorial-arrow",o("tutorial-arrow.png")),n.addImg("heart",o("heart.png")),n.addImg("score",o("score.png")),n.addAudio("drop-perfect",o("drop-perfect.mp3")),n.addAudio("drop",o("drop.mp3")),n.addAudio("game-over",o("game-over.mp3")),n.addAudio("rotate",o("rotate.mp3")),n.addAudio("bgm",o("bgm.mp3")),n.addAudio("greenbgm",o("greenbgm.mp3")),n.addAudio("bluebgm",o("bluebgm.mp3")),n.setVariable(F,.25*n.width),n.setVariable(_,.71*n.getVariable(F)),n.setVariable(S,.3*n.width),n.setVariable(R,.05*n.width),n.setVariable(N,.005*n.height),n.setVariable(D,.4*n.height),n.setVariable(P,0),n.setVariable(x,0),n.setVariable(f,0),n.setVariable(k,0),n.setVariable(w,!1),n.setVariable(y,e),n.addImg("raindrop",o("raindrop.png"));for(let t=1;t<=4;t+=1){const i=new b({name:`cloud_${t}`,action:ue,painter:me});i.index=t,i.count=5-t,n.addInstance(i),e.block.split("block")[0]}n.generateRaindrops=()=>{for(let e=1;e<=4;e+=1)for(let t=0;t<5;t++){const i=new b({name:`raindrop_${e}_${t}`,action:Le,painter:Me});i.index=e,i.count=5-e,i.cloud=n.getInstance(`cloud_${e}`),n.addInstance(i)}},n.removeRaindrops=()=>{for(let e=1;e<=4;e+=1)for(let t=0;t<5;t++)n.removeInstance(`raindrop_${e}_${t}`)},"blue"==e.block.split("block")[0]&&n.generateRaindrops();const h=new b({name:"line",action:de,painter:le});n.addInstance(h);const c=new b({name:"hook",action:be,painter:pe});return n.addInstance(c),n.startAnimate=Oe,n.endAnimate=Ve,n.paintUnderInstance=ce,n.addKeyDownListener("enter",(()=>{n.debug&&n.togglePaused()})),n.touchStartListener=()=>{(e=>{if(!e.getVariable(p))return;if(e.debug&&e.paused)return;if(se(e)!==A)return;e.removeInstance("tutorial"),e.removeInstance("tutorial-arrow");const t=e.getInstance(`block_${e.getVariable(P)}`);t&&t.status===$&&(e.setTimeMovement(z,500),t.status=U)})(n)},n.playBgm=()=>{n.playAudio(n.getVariable(L).split("block")[0]+"bgm",!0),console.log(n.getVariable(L).split("block")[0]+"bgm")},n.pauseBgm=()=>{n.pauseAudio(n.getVariable(L).split("block")[0]+"bgm")},n.start=()=>{const e=new b({name:"tutorial",action:ye,painter:we});n.addInstance(e);const t=new b({name:"tutorial-arrow",action:ye,painter:we});n.addInstance(t),n.setTimeMovement(Y,500),n.setTimeMovement(Z,500),n.setVariable(p,!0)},n}})();